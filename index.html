<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第一轮疾病病因关联调查</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .step {
      display: none;
      min-height: 300px;
    }
    .step.active {
      display: block;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .progress {
      margin-bottom: 30px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
      overflow-x: auto;
    }
    .progress span {
      margin-right: 20px;
      padding: 5px 10px;
      border-radius: 3px;
      white-space: nowrap;
    }
    .progress span.active {
      background-color: #4CAF50;
      color: white;
    }
    .question {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .category-item, .disease-item {
      margin: 8px 0;
    }
    select, input[type="checkbox"], input[type="text"] {
      margin: 5px;
    }
    input[type="text"] {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: calc(100% - 150px);
      min-width: 250px;
      margin-bottom: 10px;
      -webkit-appearance: none;
      appearance: none;
      font-size: 16px;
    }
    @media (max-width: 600px) {
      input[type="text"] {
        width: 100%;
        min-width: auto;
        margin-left: 0;
      }
      label.form-label {
        display: block;
        width: 100%;
        text-align: left;
        margin-bottom: 5px;
      }
      .question {
        padding: 10px;
      }
    }
    label.form-label {
      display: inline-block;
      width: 120px;
      text-align: right;
      margin-right: 10px;
      vertical-align: top;
    }
    button {
      margin: 10px 5px;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    button.secondary {
      background-color: #f44336;
    }
    button.secondary:hover {
      background-color: #d32f2f;
    }
    .message {
      padding: 10px;
      margin: 15px 0;
      border-radius: 4px;
      display: none;
    }
    .success {
      background-color: #dff0d8;
      color: #3c763d;
      display: block;
    }
    .error {
      background-color: #f2dede;
      color: #a94442;
      display: block;
    }
    .summary {
      margin: 20px 0;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .instructions {
      background-color: #e8f5e9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .survey-modules {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 25px;
    }
    .main-module {
      background-color: #e8f5e9;
      padding: 20px;
      border-radius: 8px;
    }
    .classification-module {
      border: 1px solid #b3e5fc;
      background-color: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      font-size: 0.9em;
    }
    .survey-flow {
      font-size: 1.1em;
    }
    .closing-note {
      font-size: 1.1em;
      margin: 15px 0;
    }
    .target-list {
      margin: 15px 0;
      padding: 10px;
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
    }
    .cause-result {
      margin: 15px 0;
      padding: 10px;
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
    }
    .category-group {
      margin: 10px 0 15px 20px;
    }
    .final-message {
      text-align: center;
      padding: 40px 20px;
      background-color: #e8f5e9;
      border-radius: 8px;
      margin: 30px 0;
    }
    .final-message h2 {
      color: #2e7d32;
      margin: 0 0 15px 0;
    }
    .empty-state {
      color: #666;
      text-align: center;
      padding: 20px;
    }
    .confidence-rating {
      margin: 5px 0px 15px 0px;
      padding: 8px;
      background-color: #f9f9f9;
      border-radius: 6px;
    }
    .confidence-rating label {
      margin-right: 5px;
    }
    .confidence-rating input {
      margin: 0 5px 0 35px;
    }
    .doctor-info {
      background-color: #fff8e1;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #ffc107;
    }
    /* 数据提交状态提示 */
    .submit-status {
      display: inline-block;
      margin-left: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
<h1>第一轮疾病病因关联调查</h1>
<div class="progress">
  <span class="active" id="progress-step0">问卷说明</span>
  <span id="progress-step1">医师信息</span>
  <span id="progress-step2">目标疾病选择</span>
  <span id="progress-step3">目标疾病确认</span>
  <span id="progress-step4">病因选择</span>
  <span id="progress-step5">结果确认与信心评估</span>
  <span id="progress-complete">完成</span>
</div>
  
<!-- 步骤0：问卷说明 -->
<div class="step active" id="step0">
  <div class="survey-modules">
    <div class="main-module">
      <h2>调查目标</h2>
      <p>本调查旨在征询临床专家对疾病间潜在因果关系的专业见解与评估。</p>
      
      <div class="survey-flow">
        <p><strong>调查流程：</strong></p>
        <ol>
          <li>填写您的基本信息（姓名、单位及擅长专科）。</li>
          <li>选择您擅长的疾病大类，并在其下选择您熟悉的所有目标疾病（即可能由其他疾病引起的疾病）。</li>
          <li>针对您选择的每个目标疾病，依次填写可能的病因疾病（填写时请先选择病因疾病所属的大类，再选择该大类中的具体疾病）。</li>
          <li>每次选择后将显示确认结果，全部填写完成后问卷将自动结束。</li>
        </ol>
      </div>
    </div>
    
    <div class="classification-module">
      <h3>【关于本问卷疾病分类标准的说明】</h3>
      <p>本问卷中的疾病分类参考了"临床分类软件（Clinical Classifications Software, CCS）"标准。CCS是由美国卫生保健研究与品质局（AHRQ）制定的疾病分组系统，其核心是将国际疾病分类（ICD）中数千种细致的诊断代码，归纳为临床意义相近的"疾病群组"。CCS的群组分类能减少细分诊断带来的分析复杂性，便于跨疾病的关联性研究与数据分析。</p>
      <p>您在问卷中看到的疾病名称已剔除原始CCS编码，仅保留临床常用名称及对应英文名称，具体的CCS名称详见提供的excel文件。若对分类有疑义，请依据临床经验选择最贴近的选项即可。</p>
    </div>
  </div>
  
  <p class="closing-note">请根据您的专业经验或研究成果进行选择，感谢您的参与与支持！</p>
  
  <button onclick="goToStep(1)">开始调查</button>
</div>

<!-- 步骤1：医师信息收集 -->
<div class="step" id="step1">
  <div class="doctor-info">
    <h3>医师信息</h3>
    <p>请填写您的基本信息，以便我们更好地整理和分析调查结果</p>
  </div>
  
  <div class="question">
    <div>
      <label class="form-label" for="doctor-name">姓名：</label>
      <input type="text" id="doctor-name" placeholder="请输入您的姓名" tabindex="1" required>
    </div>
    
    <div>
      <label class="form-label" for="hospital">所属单位：</label>
      <input type="text" id="hospital" placeholder="请输入您所在的医院/机构" tabindex="2" required>
    </div>
    
    <div>
      <label class="form-label" for="specialty">擅长专科：</label>
      <input type="text" id="specialty" placeholder="请输入您擅长的专科领域" tabindex="3" required>
    </div>
  </div>
  
  <button class="secondary" onclick="goToStep(0)" tabindex="5">返回说明</button>
  <button onclick="validateDoctorInfo()" id="step1-next" tabindex="4">下一步</button>
  <div class="message" id="message1"></div>
</div>

<!-- 步骤2：目标疾病选择（多选题） -->
<div class="step" id="step2">
  <div class="question">
    <h3>请选择您擅长的目标疾病（可多选）</h3>
    
    <h4>1. 选择目标疾病大类（可多选）</h4>
    <div id="target-categories"></div>
    
    <h4>2. 从选中的大类中选择具体目标疾病（可多选）</h4>
    <div id="target-diseases" style="margin-top:15px;"></div>
  </div>
  <button class="secondary" onclick="goToStep(1)">返回</button>
  <button onclick="validateTargetSelection()">下一步</button>
  <div class="message" id="message2"></div>
</div>

<!-- 步骤3：目标疾病确认 -->
<div class="step" id="step3">
  <div class="question">
    <h3>您选择的目标疾病如下：</h3>
    <div id="target-summary" class="target-list"></div>
    
    <div style="margin-top:20px;">
      <h4>接下来的操作：</h4>
      <p>系统将依次为您选择的每个目标疾病收集可能的病因疾病。</p>
    </div>
  </div>
  <button class="secondary" onclick="goToStep(2)">重新选择</button>
  <button onclick="startCauseSelection()">开始选择病因</button>
</div>

<!-- 步骤4：依次显示目标疾病的病因选择 -->
<div class="step" id="step4">
  <div class="question">
    <h3 id="current-target-title">请选择可能导致【目标疾病】的病因疾病</h3>
    
    <h4>1. 选择可能的病因疾病大类（可多选）</h4>
    <div id="current-cause-categories"></div>
    
    <h4>2. 从选中的大类中选择具体病因疾病（可多选）</h4>
    <div id="current-cause-diseases" style="margin-top:15px;"></div>
  </div>
  <button class="secondary" onclick="goToPreviousStep()">上一步</button>
  <button onclick="validateCauseSelection()">下一步</button>
  <div class="message" id="message4"></div>
</div>

<!-- 步骤5：病因选择结果确认与信心评估 -->
<div class="step" id="step5">
  <div class="question">
    <h3>【病因选择结果确认与信心评估】</h3>
    <p>请为以下每个病因疾病与目标疾病的关联性进行信心评估（1=非常不确定，5=非常确定）：</p>
    <div id="cause-result-summary" class="cause-result"></div>
  </div>
  <button class="secondary" onclick="goToStep(4)">重新选择</button>
  <button onclick="validateConfidenceAndProceed()">确认并下一步</button>
  <div class="message" id="message5"></div>
</div>

<!-- 结束页面 -->
<div class="step" id="complete">
  <div class="final-message">
    <h2>问卷完成，感谢您的填写！</h2>
    <p>您已成功完成所有目标疾病的病因关联调查</p>
    <div id="submit-status" class="submit-status" style="color: #666;">正在保存您的问卷数据...</div>
  </div>
  
  <div class="summary">
    <h3>调查总览</h3>
    <div id="final-summary">
      <div class="empty-state" id="empty-summary">
        正在加载您的调查结果...
      </div>
    </div>
  </div>
</div>


<script>
  let diseaseData;
  let userData = {
    expertId: generateAnonymousId(),
    currentRound: 1,
    doctorName: '',
    hospital: '',
    specialty: '',
    targetDiseases: [],
    currentTargetIndex: 0,
    allCauses: [],
    submitTime: '' // 记录提交时间
  };
  
  // 配置Google Apps Script地址（请替换为你自己的部署地址）
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcK5zYZsOuFizvUrAQ0ouO_31Gff_R4ti16KZXyd6RNh6T6FbApFkIYr8YXaAZmB-n/exec";
  
  // 生成匿名ID（用于区分不同专家，保护隐私）
  function generateAnonymousId() {
    return 'exp_' + Math.random().toString(36).substr(2, 9) + '_' + new Date().getTime();
  }
  
  // 页面加载初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 初始化疾病数据
    diseaseData = {
      "心血管系统疾病（Cardiovascular Diseases）": [
        "心脏瓣膜疾病（Heart valve disorders）",
        "原发性高血压（Essential hypertension）",
        "高血压伴并发症和继发性高血压（Hypertension with complications and secondary hypertension）",
        "冠状动脉粥样硬化和其他心脏病（Coronary atherosclerosis and other heart disease）",
        "其他和未明确的心脏病（Other and ill-defined heart disease）",
        "心律失常（Cardiac dysrhythmias）",
        "充血性心力衰竭；非高血压性（Congestive heart failure; nonhypertensive）",
        "周围性和内脏动脉粥样硬化（Peripheral and visceral atherosclerosis）",
        "其他循环系统疾病（Other circulatory disease）"
      ],
      "脑血管及神经系统疾病（Cerebrovascular & Neurological Diseases）": [
        "急性脑血管疾病（Acute cerebrovascular disease）",
        "其他和定义不清的脑血管疾病（Other and ill-defined cerebrovascular disease）",
        "短暂性脑缺血（Transient cerebral ischemia）",
        "脑血管病后遗症（Late effects of cerebrovascular disease）",
        "其他遗传性和变性神经系统疾病（Other hereditary and degenerative nervous system conditions）",
        "瘫痪（Paralysis）",
        "头痛；包括偏头痛（Headache; including migraine）",
        "神经系统病变（Other nervous system disorders）"
      ],
      "呼吸系统疾病（Respiratory Diseases）": [
        "肺炎（由结核病或性传播疾病引起的肺炎除外）（Pneumonia (except that caused by tuberculosis or sexually transmitted disease)）",
        "流感（Influenza）",
        "急性和慢性扁桃体炎（Acute and chronic tonsillitis）",
        "急性支气管炎（Acute bronchitis）",
        "其他上呼吸道感染（Other upper respiratory infections）",
        "慢性阻塞性肺病和支气管扩张（Chronic obstructive pulmonary disease and bronchiectasis）",
        "哮喘（Asthma）",
        "胸膜炎；气胸；肺不张（Pleurisy; pneumothorax; pulmonary collapse）",
        "呼吸衰竭；呼吸功能不全；呼吸暂停（成人）（Respiratory failure; insufficiency; arrest (adult)）",
        "其他下呼吸道疾病（Other lower respiratory disease）",
        "其他上呼吸道疾病（Other upper respiratory disease）"
      ],
      "消化系统疾病（Gastrointestinal Diseases）": [
        "肠道感染（Intestinal infection）",
        "食管异常（Esophageal disorders）",
        "胃十二指肠溃疡（出血除外）（Gastroduodenal ulcer (except hemorrhage)）",
        "胃炎和十二指肠炎（Gastritis and duodenitis）",
        "其他胃和十二指肠疾病（Other disorders of stomach and duodenum）",
        "阑尾炎及其他阑尾疾病（Appendicitis and other appendiceal conditions）",
        "腹疝（Abdominal hernia）",
        "局部肠炎和溃疡性结肠炎（Regional enteritis and ulcerative colitis）",
        "肠梗阻无疝气（Intestinal obstruction without hernia）",
        "肛门和直肠疾病（Anal and rectal conditions）",
        "胆道疾病（Biliary tract disease）",
        "其他肝脏疾病（Other liver diseases）",
        "胃肠出血（Gastrointestinal hemorrhage）",
        "非感染性胃肠炎（Noninfectious gastroenteritis）",
        "其他胃肠道疾病（Other gastrointestinal disorders）"
      ],
      "泌尿生殖系统疾病（Genitourinary Diseases）": [
        "肾炎；肾病；肾硬化（Nephritis; nephrosis; renal sclerosis）",
        "急性和未特指的肾衰竭（Acute and unspecified renal failure）",
        "慢性肾脏疾病（Chronic kidney disease）",
        "尿路感染（Urinary tract infections）",
        "尿路结石（Calculus of urinary tract）",
        "肾脏和输尿管的其他疾病（Other diseases of kidney and ureters）",
        "其他膀胱和尿道疾病（Other diseases of bladder and urethra）",
        "泌尿生殖系统症状和未明确情况（Genitourinary symptoms and ill-defined conditions）",
        "前列腺增生（Hyperplasia of prostate）",
        "男性生殖器官的炎症状况（Inflammatory conditions of male genital organs）",
        "其他男性生殖器疾病（Other male genital disorders）",
        "非恶性乳腺疾病（Nonmalignant breast conditions）",
        "女性盆腔器官炎症性疾病（Inflammatory diseases of female pelvic organs）",
        "子宫内膜异位症（Endometriosis）",
        "月经不调（Menstrual disorders）",
        "卵巢囊肿（Ovarian cyst）",
        "更年期疾病（Menopausal disorders）",
        "女性不孕症（Female infertility）",
        "其他女性生殖器疾病（Other female genital disorders）"
      ],
      "内分泌、代谢及营养疾病（Endocrine, Metabolic & Nutritional Disorders）": [
        "甲状腺疾病（Thyroid disorders）",
        "无并发症的糖尿病（Diabetes mellitus without complication）",
        "伴有并发症的糖尿病（Diabetes mellitus with complications）",
        "其他内分泌疾病（Other endocrine disorders）",
        "脂质代谢紊乱（Disorders of lipid metabolism）",
        "痛风和其他结晶性关节病（Gout and other crystal arthropathies）",
        "水和电解质紊乱（Fluid and electrolyte disorders）",
        "其他营养、内分泌和代谢紊乱（Other nutritional; endocrine; and metabolic disorders）",
        "缺乏和其他贫血（Deficiency and other anemia）"
      ],
      "肌肉骨骼系统疾病（Musculoskeletal Disorders）": [
        "类风湿性关节炎及相关疾病（Rheumatoid arthritis and related disease）",
        "骨关节炎（Osteoarthritis）",
        "其他非创伤性关节疾病（Other non-traumatic joint disorders）",
        "脊柱炎；椎间盘疾病；其他背部问题（Spondylosis; intervertebral disc disorders; other back problems）",
        "骨质疏松症（Osteoporosis）",
        "其他获得性畸形（Other acquired deformities）",
        "其他先天畸形（Other congenital anomalies）",
        "系统性红斑狼疮和结缔组织疾病（Systemic lupus erythematosus and connective tissue disorders）",
        "结缔组织疾病（Other connective tissue disease）",
        "其他骨骼疾病和肌肉骨骼畸形（Other bone disease and musculoskeletal deformities）",
        "关节疾病和脱位；创伤相关（Joint disorders and dislocations; trauma-related）"
      ],
      "感染性疾病（Infectious Diseases）": [
        "结核病（Tuberculosis）",
        "败血症（分娩时除外）（Septicemia (except in labor)）",
        "细菌感染，部位未特指（Bacterial infection; unspecified site）",
        "真菌疾病（Mycoses）",
        "肝炎（Hepatitis）",
        "病毒感染（Viral infection）",
        "其他感染；包括寄生虫（Other infections; including parasitic）"
      ],
      "皮肤及皮下组织疾病（Skin & Subcutaneous Tissue Disorders）": [
        "皮肤和皮下组织感染（Skin and subcutaneous tissue infections）",
        "皮肤的其他炎症状况（Other inflammatory condition of skin）",
        "慢性皮肤溃疡（Chronic ulcer of skin）",
        "其他皮肤病（Other skin disorders）"
      ],
      "精神及行为障碍（Mental & Behavioral Disorders）": [
        "焦虑症（Anxiety disorders）",
        "谵妄性痴呆和遗忘及其他认知障碍（Delirium dementia and amnestic and other cognitive disorders）",
        "情绪障碍（Mood disorders）",
        "酒精相关障碍（Alcohol-related disorders）",
        "心理健康和药物滥用法规的筛查和历史记录（Screening and history of mental health and substance abuse codes）",
        "其他精神健康障碍（Miscellaneous mental health disorders）"
      ],
      "眼耳鼻喉疾病（Eye, Ear & ENT Disorders）": [
        "白内障（Cataract）",
        "视网膜脱离；缺陷；血管阻塞；视网膜病变（Retinal detachments; defects; vascular occlusion; and retinopathy）",
        "青光眼（Glaucoma）",
        "失明和视力缺陷（Blindness and vision defects）",
        "炎症；眼睛感染（由结核病或性传播疾病引起的除外）（Inflammation; infection of eye (except that caused by tuberculosis or sexually transmitted disease)）",
        "其他眼部疾病（Other eye disorders）",
        "中耳炎和相关疾病（Otitis media and related conditions）",
        "与头晕或眩晕相关的病症（Conditions associated with dizziness or vertigo）",
        "其他耳朵和感觉器官疾病（Other ear and sense organ disorders）"
      ],
      "肿瘤及血液疾病（Neoplasms & Hematological Disorders）": [
        "性质不明或行为不确定的肿瘤（Neoplasms of unspecified nature or uncertain behavior）",
        "子宫良性肿瘤（Benign neoplasm of uterus）",
        "其他和未明确的良性肿瘤（Other and unspecified benign neoplasm）",
        "缺乏和其他贫血（Deficiency and other anemia）"
      ],
      "其他（Miscellaneous）": [
        "痔（Hemorrhoids）",
        "牙齿和下颌疾病（Disorders of teeth and jaw）",
        "口腔疾病；不包括牙科（Diseases of mouth; excluding dental）",
        "淋巴结炎（Lymphadenitis）",
        "过敏反应（Allergic reactions）"
      ]
    };
    
    // 初始化疾病选择界面
    initTargetSelection();
    initCauseCategories();

    // 修复PC端点击下一步无响应问题
    document.getElementById('step1-next').addEventListener('click', function(e) {
      e.preventDefault();
      validateDoctorInfo();
    });

    // 超时保险
    setTimeout(() => {
      const activeStep = document.querySelector('.step.active');
      if (activeStep && activeStep.id !== 'complete') {
        forceFinish();
      }
    }, 1200000); // 5分钟超时
  });
  
  // 验证医师信息
  function validateDoctorInfo() {
    const name = document.getElementById('doctor-name').value.trim();
    const hospital = document.getElementById('hospital').value.trim();
    const specialty = document.getElementById('specialty').value.trim();
    
    if (!name || !hospital || !specialty) {
      showMessage('请填写完整的医师信息', 1, 'error');
      return;
    }
    
    // 保存医师信息
    userData.doctorName = name;
    userData.hospital = hospital;
    userData.specialty = specialty;
    
    goToStep(2);
  }
  
  // 初始化目标疾病选择
  function initTargetSelection() {
    const targetCategoriesDiv = document.getElementById('target-categories');
    targetCategoriesDiv.innerHTML = '';
    Object.keys(diseaseData).forEach(category => {
      targetCategoriesDiv.innerHTML += `
        <div class="category-item">
          <input type="checkbox" id="target-category-${category.replace(/\s+/g, '-')}" 
                 value="${category}" onchange="updateTargetDiseases()">
          <label for="target-category-${category.replace(/\s+/g, '-')}">${category}</label>
        </div>
      `;
    });
  }
  
  // 更新目标疾病列表
  function updateTargetDiseases() {
    const selectedCategories = [];
    document.querySelectorAll('#target-categories input:checked').forEach(checkbox => {
      selectedCategories.push(checkbox.value);
    });
    const targetDiseasesDiv = document.getElementById('target-diseases');
    targetDiseasesDiv.innerHTML = selectedCategories.length === 0 
      ? '<p>请先选择至少一个目标疾病大类</p>' 
      : '';
    
    selectedCategories.forEach(category => {
      let html = `<div style="margin-bottom:15px;"><strong>${category}</strong>`;
      diseaseData[category].forEach(disease => {
        html += `
          <div class="disease-item">
            <input type="checkbox" id="target-disease-${disease.replace(/\s+/g, '-')}" 
                   value="${disease}" data-category="${category}">
            <label for="target-disease-${disease.replace(/\s+/g, '-')}">${disease}</label>
          </div>
        `;
      });
      html += '</div>';
      targetDiseasesDiv.innerHTML += html;
    });
  }
  
  // 验证目标疾病选择
  function validateTargetSelection() {
    const selectedDiseases = [];
    document.querySelectorAll('#target-diseases input:checked').forEach(checkbox => {
      selectedDiseases.push({
        category: checkbox.getAttribute('data-category'),
        name: checkbox.value
      });
    });
    if (selectedDiseases.length === 0) {
      showMessage('请至少选择一个具体的目标疾病', 2, 'error');
      return;
    }
    userData.targetDiseases = selectedDiseases;
    
    // 生成目标疾病确认内容
    const targetSummary = document.getElementById('target-summary');
    targetSummary.innerHTML = selectedDiseases.map((d, i) => 
      `<p><strong>${i+1}. ${d.name}</strong>（大类：${d.category}）</p>`
    ).join('');
    
    goToStep(3);
  }
  
  // 初始化病因大类
  function initCauseCategories() {
    const causeCategoriesDiv = document.getElementById('current-cause-categories');
    causeCategoriesDiv.innerHTML = '';
    Object.keys(diseaseData).forEach(category => {
      causeCategoriesDiv.innerHTML += `
        <div class="category-item">
          <input type="checkbox" id="cause-category-${category.replace(/\s+/g, '-')}" 
                 value="${category}" onchange="updateCurrentCauseDiseases()">
          <label for="cause-category-${category.replace(/\s+/g, '-')}">${category}</label>
        </div>
      `;
    });
  }
  
  // 更新病因疾病列表
  function updateCurrentCauseDiseases() {
    const selectedCategories = [];
    document.querySelectorAll('#current-cause-categories input:checked').forEach(checkbox => {
      selectedCategories.push(checkbox.value);
    });
    const causeDiseasesDiv = document.getElementById('current-cause-diseases');
    causeDiseasesDiv.innerHTML = selectedCategories.length === 0 
      ? '<p>请先选择至少一个病因疾病大类</p>' 
      : '';
    
    selectedCategories.forEach(category => {
      let html = `<div style="margin-bottom:15px;"><strong>${category}</strong>`;
      diseaseData[category].forEach(disease => {
        html += `
          <div class="disease-item">
            <input type="checkbox" id="current-cause-disease-${disease.replace(/\s+/g, '-')}" 
                   value="${disease}" data-category="${category}">
            <label for="current-cause-disease-${disease.replace(/\s+/g, '-')}">${disease}</label>
          </div>
        `;
      });
      html += '</div>';
      causeDiseasesDiv.innerHTML += html;
    });
  }
  
  // 开始处理病因选择
  function startCauseSelection() {
    userData.currentTargetIndex = 0;
    userData.allCauses = [];
    loadCurrentTargetCauseSelection();
    goToStep(4);
  }
  
  // 加载当前目标疾病的病因选择
  function loadCurrentTargetCauseSelection() {
    const currentTarget = userData.targetDiseases[userData.currentTargetIndex];
    document.getElementById('current-target-title').textContent = 
      `请选择可能导致【${currentTarget.name}】的病因疾病`;
    
    // 重置选择框
    document.querySelectorAll('#current-cause-categories input').forEach(cb => cb.checked = false);
    document.getElementById('current-cause-diseases').innerHTML = '<p>请先选择至少一个病因疾病大类</p>';
  }
  
  // 验证病因选择并进入信心评估
  function validateCauseSelection() {
    const selectedCauseCategories = [];
    document.querySelectorAll('#current-cause-categories input:checked').forEach(cb => {
      selectedCauseCategories.push(cb.value);
    });
    
    const selectedCauseDiseases = [];
    document.querySelectorAll('#current-cause-diseases input:checked').forEach(cb => {
      selectedCauseDiseases.push({
        category: cb.getAttribute('data-category'),
        name: cb.value
      });
    });
    
    if (selectedCauseCategories.length === 0 || selectedCauseDiseases.length === 0) {
      showMessage('请至少选择一个病因大类和对应的具体疾病', 4, 'error');
      return;
    }
    
    // 保存当前病因数据
    userData.allCauses.push({
      target: userData.targetDiseases[userData.currentTargetIndex],
      diseases: selectedCauseDiseases,
      confidenceScores: {}
    });
    
    // 生成带信心评估的确认内容
    generateCauseConfirmation();
    goToStep(5);
  }
  
  // 生成带信心评估的病因确认页内容
  function generateCauseConfirmation() {
    const resultSummary = document.getElementById('cause-result-summary');
    const currentEntry = userData.allCauses[userData.allCauses.length - 1];
    const currentTarget = currentEntry.target;
    
    let html = `<p><strong>目标疾病：${currentTarget.name}</strong>（${currentTarget.category}）</p>`;
    
    // 按大类分组生成列表
    const categoryGroups = {};
    currentEntry.diseases.forEach(d => {
      if (!categoryGroups[d.category]) categoryGroups[d.category] = [];
      categoryGroups[d.category].push(d.name);
    });
    
    Object.keys(categoryGroups).forEach(cat => {
      html += `<div class="category-group"><strong>${cat}：</strong><ul>`;
      categoryGroups[cat].forEach(disease => {
        const diseaseId = disease.replace(/\s+/g, '-');
        html += `
          <li>
            ${disease}
            <div class="confidence-rating">
              <label>信心评分：</label>
              <input type="radio" name="confidence-${diseaseId}" value="1" required>1
              <input type="radio" name="confidence-${diseaseId}" value="2">2
              <input type="radio" name="confidence-${diseaseId}" value="3">3
              <input type="radio" name="confidence-${diseaseId}" value="4">4
              <input type="radio" name="confidence-${diseaseId}" value="5">5
            </div>
          </li>
        `;
      });
      html += '</ul></div>';
    });
    
    resultSummary.innerHTML = html;
  }
  
  // 验证信心评分并进入下一步
  function validateConfidenceAndProceed() {
    // 检查是否所有病因都已评分
    const unratedCauses = [];
    const currentEntry = userData.allCauses[userData.allCauses.length - 1];
    
    currentEntry.diseases.forEach(disease => {
      const diseaseId = disease.name.replace(/\s+/g, '-');
      const isRated = document.querySelector(`input[name="confidence-${diseaseId}"]:checked`) !== null;
      if (!isRated) {
        unratedCauses.push(disease.name);
      }
    });
    
    if (unratedCauses.length > 0) {
      showMessage(`请为以下病因完成信心评估：${unratedCauses.join('、')}`, 5, 'error');
      return;
    }
    
    // 保存每个病因的信心评分
    currentEntry.diseases.forEach(disease => {
      const diseaseId = disease.name.replace(/\s+/g, '-');
      const rating = document.querySelector(`input[name="confidence-${diseaseId}"]:checked`).value;
      currentEntry.confidenceScores[disease.name] = parseInt(rating);
    });
    
    // 继续流程
    processNextTarget();
  }
  
  // 处理下一个目标疾病
  function processNextTarget() {
    userData.currentTargetIndex++;
    if (userData.currentTargetIndex < userData.targetDiseases.length) {
      loadCurrentTargetCauseSelection();
      goToStep(4);
    } else {
      // 完成所有目标疾病的评估
      try {
        generateFinalSummary();
        // 记录提交时间
        userData.submitTime = new Date().toISOString();
        // 提交数据到Google Sheets
        submitDataToGoogleSheets();
      } catch (e) {
        console.error('生成总结失败:', e);
      } finally {
        goToStep('complete');
      }
    }
  }
  
  // 生成最终总结
  function generateFinalSummary() {
    const finalSummary = document.getElementById('final-summary');
    finalSummary.innerHTML = '';
    
    if (!userData.allCauses || userData.allCauses.length === 0) {
      finalSummary.innerHTML = '<div class="empty-state">没有找到调查结果</div>';
      return;
    }
    
    userData.allCauses.forEach((item, index) => {
      let html = `
        <div style="margin-bottom:20px;">
          <p><strong>${index + 1}. 目标疾病：${item.target.name}</strong>（${item.target.category}）</p>
          <p><strong>相关病因疾病及信心评分：</strong></p>
        `;
      
      // 按大类分组
      const categoryGroups = {};
      item.diseases.forEach(d => {
        if (!categoryGroups[d.category]) categoryGroups[d.category] = [];
        categoryGroups[d.category].push(d.name);
      });
      
      Object.keys(categoryGroups).forEach(cat => {
        html += `<div class="category-group"><strong>${cat}：</strong><ul>`;
        categoryGroups[cat].forEach(d => {
          html += `<li>${d} - 信心评分：${item.confidenceScores[d]}/5</li>`;
        });
        html += '</ul></div>';
      });
      
      html += '</div>';
      finalSummary.innerHTML += html;
    });
  }
  
  // 核心功能：提交数据到Google Sheets
  function submitDataToGoogleSheets() {
    // 准备要提交的数据格式
    const submitData = {
      expertId: userData.expertId,
      doctorName: userData.doctorName,
      hospital: userData.hospital,
      specialty: userData.specialty,
      submitTime: userData.submitTime,
      targetDiseasesCount: userData.targetDiseases.length,
      allCauses: userData.allCauses.map(item => {
        return {
          targetDisease: item.target.name,
          targetCategory: item.target.category,
          causeCount: item.diseases.length,
          causes: item.diseases.map(d => ({
            causeDisease: d.name,
            causeCategory: d.category,
            confidenceScore: item.confidenceScores[d.name]
          }))
        };
      })
    };
    
    // 发送数据到Google Apps Script
    fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(submitData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('网络响应不正常');
      }
      return response.text();
    })
    .then(data => {
      console.log('数据提交成功:', data);
      document.getElementById('submit-status').textContent = '您的问卷数据已成功保存！';
      document.getElementById('submit-status').style.color = '#3c763d';
    })
    .catch(error => {
      console.error('数据提交失败:', error);
      document.getElementById('submit-status').textContent = '数据保存失败，请联系管理员！';
      document.getElementById('submit-status').style.color = '#a94442';
      
      // 失败时提供手动备份选项
      const backupData = JSON.stringify(submitData, null, 2);
      const textarea = document.createElement('textarea');
      textarea.style.width = '100%';
      textarea.style.height = '150px';
      textarea.style.marginTop = '10px';
      textarea.value = '数据备份：\n' + backupData;
      document.querySelector('.final-message').appendChild(textarea);
    });
  }
  
  // 步骤切换函数
  function goToStep(stepNumber) {
    try {
      // 移除所有步骤的active类
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
      });
      
      // 处理目标步骤
      let targetStep;
      if (stepNumber === 'complete') {
        targetStep = document.getElementById('complete');
      } else {
        targetStep = document.getElementById('step' + stepNumber);
      }
      
      if (targetStep) {
        targetStep.classList.add('active');
        window.scrollTo(0, 0);
      } else {
        forceFinish();
      }
      
      // 更新进度条
      document.querySelectorAll('.progress span').forEach(span => {
        span.classList.remove('active');
      });
      if (stepNumber === 'complete') {
        document.getElementById('progress-complete').classList.add('active');
      } else {
        for (let i = 0; i <= stepNumber; i++) {
          const el = document.getElementById('progress-step' + i);
          if (el) el.classList.add('active');
        }
      }
    } catch (error) {
      console.error('步骤切换失败:', error);
      forceFinish();
    }
  }
  
  // 强制结束函数
  function forceFinish() {
    document.querySelectorAll('.step').forEach(step => {
      step.classList.remove('active');
    });
    document.getElementById('complete').classList.add('active');
    document.querySelectorAll('.progress span').forEach(span => {
      span.classList.remove('active');
    });
    document.getElementById('progress-complete').classList.add('active');
  }
  
  // 上一步按钮逻辑
  function goToPreviousStep() {
    if (userData.currentTargetIndex === 0) {
      goToStep(3);
    } else {
      goToStep(5);
    }
  }
  
  function showMessage(text, step, type) {
    const el = document.getElementById('message' + step);
    if (el) {
      el.textContent = text;
      el.className = 'message ' + type;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
  }
</script>
</body>
</html>



